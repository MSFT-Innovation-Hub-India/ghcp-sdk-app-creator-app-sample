<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GitHub Copilot SDK - Multi-Step App Generator</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh;
      color: #e0e0e0;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }
    
    h1 {
      text-align: center;
      margin-bottom: 0.5rem;
      color: #fff;
      font-size: 2rem;
    }
    
    .subtitle {
      text-align: center;
      color: #888;
      margin-bottom: 2rem;
    }
    
    /* Progress Steps */
    .progress-bar {
      display: flex;
      justify-content: space-between;
      margin-bottom: 2rem;
      position: relative;
    }
    
    .progress-bar::before {
      content: '';
      position: absolute;
      top: 20px;
      left: 10%;
      right: 10%;
      height: 2px;
      background: #333;
      z-index: 0;
    }
    
    .step {
      display: flex;
      flex-direction: column;
      align-items: center;
      z-index: 1;
      flex: 1;
    }
    
    .step-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #333;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #666;
      transition: all 0.3s;
    }
    
    .step.active .step-circle {
      background: #4CAF50;
      color: white;
    }
    
    .step.completed .step-circle {
      background: #2196F3;
      color: white;
    }
    
    .step-label {
      margin-top: 0.5rem;
      font-size: 0.85rem;
      color: #666;
    }
    
    .step.active .step-label,
    .step.completed .step-label {
      color: #fff;
    }
    
    /* Cards */
    .card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .card h2 {
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    /* Archetype Selection */
    .archetype-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    
    .archetype-card {
      background: rgba(255, 255, 255, 0.03);
      border: 2px solid transparent;
      border-radius: 8px;
      padding: 1.25rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .archetype-card:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(76, 175, 80, 0.5);
    }
    
    .archetype-card.selected {
      border-color: #4CAF50;
      background: rgba(76, 175, 80, 0.1);
    }
    
    .archetype-card h3 {
      margin-bottom: 0.5rem;
    }
    
    .archetype-card p {
      font-size: 0.9rem;
      color: #888;
      margin-bottom: 0.75rem;
    }
    
    .tech-stack {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    
    .tech-tag {
      background: rgba(33, 150, 243, 0.2);
      color: #64B5F6;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
    }
    
    /* Form Elements */
    textarea {
      width: 100%;
      min-height: 120px;
      padding: 1rem;
      border: 1px solid #333;
      border-radius: 8px;
      background: rgba(0, 0, 0, 0.3);
      color: #fff;
      font-family: inherit;
      font-size: 1rem;
      resize: vertical;
    }
    
    textarea:focus {
      outline: none;
      border-color: #4CAF50;
    }
    
    .file-upload {
      margin-top: 1rem;
      padding: 1rem;
      border: 2px dashed #333;
      border-radius: 8px;
      text-align: center;
    }
    
    .file-upload.has-file {
      border-color: #4CAF50;
      background: rgba(76, 175, 80, 0.1);
    }
    
    /* Buttons */
    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .btn-primary {
      background: #4CAF50;
      color: white;
    }
    
    .btn-primary:hover {
      background: #45a049;
    }
    
    .btn-primary:disabled {
      background: #333;
      color: #666;
      cursor: not-allowed;
    }
    
    .btn-secondary {
      background: transparent;
      border: 1px solid #666;
      color: #888;
    }
    
    .btn-secondary:hover {
      border-color: #888;
      color: #fff;
    }
    
    .btn-group {
      display: flex;
      gap: 1rem;
      margin-top: 1.5rem;
    }
    
    /* Phase List */
    .phase-list {
      margin-top: 1rem;
    }
    
    .phase-item {
      display: flex;
      align-items: center;
      padding: 0.75rem 1rem;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      margin-bottom: 0.5rem;
      border-left: 4px solid #333;
    }
    
    .phase-item.pending {
      border-left-color: #666;
    }
    
    .phase-item.in_progress {
      border-left-color: #FFC107;
      background: rgba(255, 193, 7, 0.1);
    }
    
    .phase-item.completed {
      border-left-color: #4CAF50;
    }
    
    .phase-item.error {
      border-left-color: #f44336;
    }
    
    .phase-status {
      width: 24px;
      height: 24px;
      margin-right: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .phase-status .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid #FFC107;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .phase-info {
      flex: 1;
    }
    
    .phase-name {
      font-weight: 500;
    }
    
    .phase-desc {
      font-size: 0.85rem;
      color: #888;
    }
    
    .phase-files {
      font-size: 0.8rem;
      color: #4CAF50;
      margin-top: 0.25rem;
    }
    
    /* Log Output */
    .log-output {
      background: #0d1117;
      border-radius: 8px;
      padding: 1rem;
      height: 100%;
      min-height: 400px;
      max-height: 600px;
      overflow-y: auto;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 0.85rem;
      line-height: 1.5;
      white-space: pre-wrap;
      word-break: break-all;
    }
    
    /* Two-Pane Generation Layout */
    .generation-layout {
      display: grid;
      grid-template-columns: 1fr 1.5fr;
      gap: 1.5rem;
      margin-top: 1rem;
    }
    
    @media (max-width: 900px) {
      .generation-layout {
        grid-template-columns: 1fr;
      }
    }
    
    .phase-pane {
      display: flex;
      flex-direction: column;
    }
    
    .phase-pane h3, .log-pane h3 {
      margin-bottom: 0.75rem;
      font-size: 1rem;
      color: #aaa;
    }
    
    .log-pane {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    
    .log-pane .log-output {
      flex: 1;
      min-height: 250px;
      max-height: 350px;
    }
    
    /* Console Trace Section */
    .console-section {
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      padding-top: 0.75rem;
    }
    
    .console-section h4 {
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
      color: #888;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .console-section h4 .indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #4CAF50;
      animation: pulse-green 2s infinite;
    }
    
    @keyframes pulse-green {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
    
    .console-output {
      background: #000;
      border-radius: 6px;
      padding: 0.75rem;
      height: 150px;
      max-height: 200px;
      overflow-y: auto;
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      font-size: 0.75rem;
      line-height: 1.4;
      white-space: pre-wrap;
      word-break: break-all;
      color: #00ff00;
      border: 1px solid #333;
    }
    
    .console-output .trace-line {
      display: block;
      opacity: 0.9;
    }
    
    .console-output .trace-line.info { color: #64B5F6; }
    .console-output .trace-line.warn { color: #FFB74D; }
    .console-output .trace-line.error { color: #EF5350; }
    .console-output .trace-line.debug { color: #888; }
    .console-output .trace-line.success { color: #81C784; }
    
    /* Generated Files List */
    .file-list {
      max-height: 200px;
      overflow-y: auto;
      padding: 0.5rem;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
    }
    
    .file-item {
      display: flex;
      align-items: center;
      padding: 0.35rem 0.5rem;
      font-size: 0.85rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .file-item:last-child {
      border-bottom: none;
    }
    
    .file-item .icon {
      margin-right: 0.5rem;
      font-size: 0.9rem;
    }
    
    .file-item.python .icon { color: #3572A5; }
    .file-item.javascript .icon { color: #F1E05A; }
    .file-item.json .icon { color: #CBCB41; }
    .file-item.markdown .icon { color: #083FA1; }
    .file-item.text .icon { color: #888; }

    /* Confirmation Dialog */
    .confirmation-banner {
      background: rgba(255, 193, 7, 0.1);
      border: 1px solid #FFC107;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .confirmation-banner .message {
      flex: 1;
    }
    
    .confirmation-banner h3 {
      color: #FFC107;
      margin-bottom: 0.25rem;
    }
    
    .confirmation-banner p {
      color: #888;
      font-size: 0.9rem;
    }
    
    /* Final Result */
    .result-banner {
      padding: 1.5rem;
      border-radius: 8px;
      text-align: center;
    }
    
    .result-banner.success {
      background: rgba(76, 175, 80, 0.1);
      border: 1px solid #4CAF50;
    }
    
    .result-banner.error {
      background: rgba(244, 67, 54, 0.1);
      border: 1px solid #f44336;
    }
    
    .result-banner h2 {
      justify-content: center;
    }
    
    .result-url {
      display: inline-block;
      background: rgba(33, 150, 243, 0.2);
      color: #64B5F6;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      margin-top: 1rem;
      text-decoration: none;
    }
    
    .result-url:hover {
      background: rgba(33, 150, 243, 0.3);
    }
    
    /* Hidden sections */
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üöÄ GitHub Copilot SDK - Multi-Step App Generator</h1>
    <p class="subtitle">Generate complete applications with AI-powered code generation, step by step</p>
    
    <!-- Progress Bar -->
    <div class="progress-bar">
      <div class="step active" id="step-describe">
        <div class="step-circle">1</div>
        <span class="step-label">Describe</span>
      </div>
      <div class="step" id="step-archetype">
        <div class="step-circle">2</div>
        <span class="step-label">Architecture</span>
      </div>
      <div class="step" id="step-generate">
        <div class="step-circle">3</div>
        <span class="step-label">Generate</span>
      </div>
      <div class="step" id="step-deploy">
        <div class="step-circle">4</div>
        <span class="step-label">Deploy</span>
      </div>
    </div>
    
    <!-- Step 1: Describe Application -->
    <section id="section-describe" class="card">
      <h2>üìù Describe Your Application</h2>
      <textarea id="prompt" placeholder="Describe the application you want to create...

Example: A task management API with user authentication, projects, tasks with priorities and due dates, and labels for organizing tasks."></textarea>
      
      <div class="file-upload" id="file-upload-area">
        <input type="file" id="attachment" accept=".txt,.md,.pdf" style="display:none" />
        <p>üìé <a href="#" onclick="document.getElementById('attachment').click(); return false;">Attach a BRD or specification document</a> (optional)</p>
        <p style="font-size: 0.85rem; color: #666;">Supported: .txt, .md, .pdf (max 5MB)</p>
      </div>
      <div id="file-preview" class="hidden" style="margin-top: 1rem; padding: 1rem; background: rgba(76, 175, 80, 0.1); border-radius: 8px;">
        <strong>üìÑ Attached:</strong> <span id="file-name"></span>
        <a href="#" onclick="removeAttachment(); return false;" style="margin-left: 1rem; color: #f44336;">‚úï Remove</a>
      </div>
      
      <div class="btn-group">
        <button class="btn btn-primary" id="btn-continue-to-arch" disabled>Continue ‚Üí Select Architecture</button>
      </div>
    </section>
    
    <!-- Step 2: Select Architecture -->
    <section id="section-archetype" class="card hidden">
      <h2>üèóÔ∏è Select Application Architecture</h2>
      <p style="color: #888; margin-bottom: 1rem;">Choose the tech stack and structure for your application:</p>
      
      <div class="archetype-grid" id="archetype-grid">
        <!-- Archetypes will be loaded dynamically -->
      </div>
      
      <div class="btn-group">
        <button class="btn btn-secondary" onclick="goToStep(1)">‚Üê Back</button>
        <button class="btn btn-primary" id="btn-start-generation" disabled>Start Generation ‚Üí</button>
      </div>
    </section>
    
    <!-- Step 3: Generation Progress -->
    <section id="section-generate" class="card hidden">
      <h2>‚öôÔ∏è Generating Application</h2>
      
      <!-- Confirmation Banner (shown when awaiting confirmation) -->
      <div id="confirmation-banner" class="confirmation-banner hidden">
        <div class="message">
          <h3 id="confirm-phase-name">Ready for next phase</h3>
          <p id="confirm-phase-desc">Click 'Proceed' to continue generation</p>
        </div>
        <div class="btn-group" style="margin-top: 0;">
          <button class="btn btn-secondary" id="btn-skip-phase">Skip (optional)</button>
          <button class="btn btn-primary" id="btn-proceed-phase">‚úì Proceed</button>
        </div>
      </div>
      
      <!-- Two-Pane Layout: Phases on left, Logs on right -->
      <div class="generation-layout">
        <!-- Left Pane: Phase List -->
        <div class="phase-pane">
          <h3>üìã Phases</h3>
          <div class="phase-list" id="phase-list">
            <!-- Phases will be populated dynamically -->
          </div>
          
          <!-- File List -->
          <div id="file-list-section" class="hidden" style="margin-top: 1rem;">
            <h4>üìÅ Generated Files</h4>
            <div class="file-list" id="generated-files"></div>
          </div>
        </div>
        
        <!-- Right Pane: Live Logs -->
        <div class="log-pane">
          <h3>üìú Live Execution Log</h3>
          <div class="log-output" id="log-output"></div>
          
          <!-- Console Trace Section -->
          <div class="console-section">
            <h4><span class="indicator" id="console-indicator"></span> Console Trace</h4>
            <div class="console-output" id="console-trace"></div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Step 4: Deployment & Result -->
    <section id="section-deploy" class="card hidden">
      <div id="result-content">
        <!-- Result will be shown here -->
      </div>
    </section>
  </div>
  
  <script>
    // State
    let currentStep = 1;
    let selectedArchetype = null;
    let attachmentData = null;
    let currentJobId = null;
    let phases = [];
    let pendingPhaseIndex = null;
    const allGeneratedFiles = new Set();
    
    // DOM Elements
    const promptInput = document.getElementById('prompt');
    const attachmentInput = document.getElementById('attachment');
    const filePreview = document.getElementById('file-preview');
    const fileName = document.getElementById('file-name');
    const btnContinue = document.getElementById('btn-continue-to-arch');
    const btnStart = document.getElementById('btn-start-generation');
    const archetypeGrid = document.getElementById('archetype-grid');
    const phaseList = document.getElementById('phase-list');
    const logOutput = document.getElementById('log-output');
    const consoleTrace = document.getElementById('console-trace');
    const consoleIndicator = document.getElementById('console-indicator');
    const confirmationBanner = document.getElementById('confirmation-banner');
    
    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      await loadArchetypes();
      
      promptInput.addEventListener('input', updateContinueButton);
      attachmentInput.addEventListener('change', handleFileSelect);
    });
    
    // Load archetypes from server
    async function loadArchetypes() {
      try {
        const response = await fetch('/api/archetypes');
        const archetypes = await response.json();
        renderArchetypes(archetypes);
      } catch (error) {
        console.error('Failed to load archetypes:', error);
        // Fallback to hardcoded archetypes
        renderArchetypes([
          { id: 'fastapi-sqlite', name: 'FastAPI + SQLite Backend', description: 'Python REST API with SQLite database', stack: ['Python', 'FastAPI', 'SQLite', 'pytest'] },
          { id: 'react-fastapi', name: 'React + FastAPI Full-Stack', description: 'React frontend with FastAPI backend', stack: ['React', 'TypeScript', 'Python', 'FastAPI'] },
          { id: 'nodejs-express', name: 'Node.js + Express Backend', description: 'Express.js REST API with SQLite', stack: ['Node.js', 'Express', 'SQLite', 'Jest'] },
          { id: 'custom', name: 'Custom Architecture', description: 'AI will propose architecture based on your requirements', stack: ['Determined by AI'] },
        ]);
      }
    }
    
    // Render archetype cards
    function renderArchetypes(archetypes) {
      archetypeGrid.innerHTML = archetypes.map(arch => `
        <div class="archetype-card" data-id="${arch.id}" onclick="selectArchetype('${arch.id}')">
          <h3>${arch.name}</h3>
          <p>${arch.description}</p>
          <div class="tech-stack">
            ${arch.stack.map(tech => `<span class="tech-tag">${tech}</span>`).join('')}
          </div>
        </div>
      `).join('');
    }
    
    // Select archetype
    function selectArchetype(id) {
      selectedArchetype = id;
      document.querySelectorAll('.archetype-card').forEach(card => {
        card.classList.toggle('selected', card.dataset.id === id);
      });
      btnStart.disabled = false;
    }
    
    // Handle file selection
    async function handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      if (file.size > 5 * 1024 * 1024) {
        alert('File too large. Maximum size is 5MB.');
        return;
      }
      
      const text = await file.text();
      attachmentData = {
        name: file.name,
        content: text,
        type: file.type,
      };
      
      fileName.textContent = file.name;
      filePreview.classList.remove('hidden');
      document.getElementById('file-upload-area').classList.add('has-file');
      updateContinueButton();
    }
    
    // Remove attachment
    function removeAttachment() {
      attachmentData = null;
      attachmentInput.value = '';
      filePreview.classList.add('hidden');
      document.getElementById('file-upload-area').classList.remove('has-file');
    }
    
    // Update continue button state
    function updateContinueButton() {
      btnContinue.disabled = !promptInput.value.trim();
    }
    
    // Navigation
    function goToStep(step) {
      currentStep = step;
      
      // Update progress bar
      document.querySelectorAll('.step').forEach((el, i) => {
        el.classList.remove('active', 'completed');
        if (i + 1 < step) el.classList.add('completed');
        if (i + 1 === step) el.classList.add('active');
      });
      
      // Show/hide sections
      document.getElementById('section-describe').classList.toggle('hidden', step !== 1);
      document.getElementById('section-archetype').classList.toggle('hidden', step !== 2);
      document.getElementById('section-generate').classList.toggle('hidden', step !== 3);
      document.getElementById('section-deploy').classList.toggle('hidden', step !== 4);
    }
    
    // Continue to architecture selection
    btnContinue.addEventListener('click', () => {
      if (promptInput.value.trim()) {
        goToStep(2);
      }
    });
    
    // Start generation
    btnStart.addEventListener('click', async () => {
      if (!selectedArchetype) return;
      
      goToStep(3);
      logOutput.textContent = '';
      phaseList.innerHTML = '';
      clearConsoleTrace();
      
      // Reset file list
      allGeneratedFiles.clear();
      document.getElementById('generated-files').innerHTML = '';
      document.getElementById('file-list-section').classList.add('hidden');
      
      try {
        // Create job
        const response = await fetch('/api/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            prompt: promptInput.value,
            archetype: selectedArchetype,
            attachment: attachmentData,
          }),
        });
        
        const { jobId } = await response.json();
        currentJobId = jobId;
        
        // Connect to SSE stream
        connectToStream(jobId);
        
      } catch (error) {
        appendLog(`‚ùå Error: ${error.message}\n`);
      }
    });
    
    // Connect to SSE stream
    function connectToStream(jobId) {
      const eventSource = new EventSource(`/api/generate/stream?jobId=${jobId}`);
      
      eventSource.addEventListener('status', (e) => {
        const data = JSON.parse(e.data);
        appendLog(`üìã ${data.message}\n`);
      });
      
      eventSource.addEventListener('plan', (e) => {
        const data = JSON.parse(e.data);
        phases = data.phases;
        renderPhases();
        appendLog(`üìê Architecture: ${data.archetype}\n`);
        appendLog(`üìù Phases: ${phases.length}\n\n`);
      });
      
      eventSource.addEventListener('phase_proposal', (e) => {
        const data = JSON.parse(e.data);
        pendingPhaseIndex = data.phaseIndex;
        showConfirmation(data.phase, data.phaseIndex, data.totalPhases);
      });
      
      eventSource.addEventListener('phase_start', (e) => {
        const data = JSON.parse(e.data);
        hideConfirmation();
        phases[data.phaseIndex].status = 'in_progress';
        renderPhases();
        appendLog(`\nüî® Starting: ${data.phase.name}\n`);
      });
      
      eventSource.addEventListener('phase_complete', (e) => {
        const data = JSON.parse(e.data);
        phases[data.phaseIndex].status = 'completed';
        phases[data.phaseIndex].files = data.files;
        renderPhases();
        addFilesToList(data.files);
        appendLog(`\n‚úÖ Completed: ${data.phase.name} (${data.files.length} files)\n`);
      });
      
      eventSource.addEventListener('phase_error', (e) => {
        const data = JSON.parse(e.data);
        phases[data.phaseIndex].status = 'error';
        renderPhases();
        appendLog(`\n‚ùå Error in ${data.phase.name}: ${data.error}\n`);
      });
      
      eventSource.addEventListener('log', (e) => {
        const data = JSON.parse(e.data);
        appendLog(data.text);
        // Also stream to console trace with debug level
        appendConsoleTrace(data.text, 'debug');
      });
      
      eventSource.addEventListener('console_trace', (e) => {
        const data = JSON.parse(e.data);
        appendConsoleTrace(data.text, data.level || 'info');
      });
      
      eventSource.addEventListener('file', (e) => {
        const data = JSON.parse(e.data);
        addFilesToList([data.path]);
        appendLog(`üìÑ [FILE] ${data.action}: ${data.path}\n`);
        appendConsoleTrace(`[FILE] ${data.action}: ${data.path}`, 'success');
      });
      
      eventSource.addEventListener('docker_deployed', (e) => {
        const data = JSON.parse(e.data);
        appendLog(`\nüéâ Docker deployment successful!\n`);
        appendLog(`üåê Application URL: ${data.url}\n`);
        appendLog(`üì¶ Container: ${data.containerName}\n\n`);
        
        // Show the deployment URL in the UI
        showDeploymentLink('docker', data.url, data.containerName);
      });
      
      eventSource.addEventListener('azure_deployed', (e) => {
        const data = JSON.parse(e.data);
        appendLog(`\n‚òÅÔ∏è Azure deployment successful!\n`);
        if (data.url) {
          appendLog(`üåê Application URL: ${data.url}\n`);
        }
        appendLog(`üì¶ Resource Group: ${data.resourceGroup}\n\n`);
        
        // Show the deployment URL in the UI
        showDeploymentLink('azure', data.url, data.resourceGroup);
      });
      
      eventSource.addEventListener('completed', (e) => {
        const data = JSON.parse(e.data);
        eventSource.close();
        showResult(true, data);
      });
      
      eventSource.addEventListener('error', (e) => {
        if (e.data) {
          const data = JSON.parse(e.data);
          appendLog(`\n‚ùå Error: ${data.message}\n`);
          showResult(false, data);
        }
        eventSource.close();
      });
    }
    
    // Render phases
    function renderPhases() {
      phaseList.innerHTML = phases.map((phase, i) => `
        <div class="phase-item ${phase.status}">
          <div class="phase-status">
            ${phase.status === 'in_progress' ? '<div class="spinner"></div>' : ''}
            ${phase.status === 'completed' ? '‚úÖ' : ''}
            ${phase.status === 'error' ? '‚ùå' : ''}
            ${phase.status === 'pending' ? '‚è≥' : ''}
            ${phase.status === 'skipped' ? '‚è≠Ô∏è' : ''}
          </div>
          <div class="phase-info">
            <div class="phase-name">${i + 1}. ${phase.name}</div>
            <div class="phase-desc">${phase.description}</div>
            ${phase.files?.length ? `<div class="phase-files">${phase.files.join(', ')}</div>` : ''}
          </div>
        </div>
      `).join('');
    }
    
    // Show confirmation banner
    function showConfirmation(phase, index, total) {
      document.getElementById('confirm-phase-name').textContent = `Phase ${index + 1}/${total}: ${phase.name}`;
      document.getElementById('confirm-phase-desc').textContent = phase.description;
      document.getElementById('btn-skip-phase').style.display = phase.optional ? 'inline-block' : 'none';
      confirmationBanner.classList.remove('hidden');
    }
    
    // Hide confirmation banner
    function hideConfirmation() {
      confirmationBanner.classList.add('hidden');
    }
    
    // Proceed with phase
    document.getElementById('btn-proceed-phase').addEventListener('click', async () => {
      if (pendingPhaseIndex === null) return;
      
      try {
        await fetch(`/api/generate/${currentJobId}/confirm`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phaseIndex: pendingPhaseIndex }),
        });
      } catch (error) {
        appendLog(`‚ùå Error confirming phase: ${error.message}\n`);
      }
    });
    
    // Skip phase
    document.getElementById('btn-skip-phase').addEventListener('click', async () => {
      if (pendingPhaseIndex === null) return;
      
      try {
        await fetch(`/api/generate/${currentJobId}/skip`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phaseIndex: pendingPhaseIndex }),
        });
      } catch (error) {
        appendLog(`‚ùå Error skipping phase: ${error.message}\n`);
      }
    });
    
    // Show final result
    function showResult(success, data) {
      goToStep(4);
      
      const resultContent = document.getElementById('result-content');
      
      if (success) {
        resultContent.innerHTML = `
          <div class="result-banner success">
            <h2>üéâ Application Generated Successfully!</h2>
            <p style="margin-top: 1rem;">Your application has been created and tested.</p>
            ${data.url ? `<a href="${data.url}" target="_blank" class="result-url">üåê Open Application: ${data.url}</a>` : ''}
            <p style="margin-top: 1rem; color: #888;">
              üìÇ Workspace: <code>${data.workspace}</code>
            </p>
            ${data.container ? `<p style="color: #888;">üì¶ Container: <code>${data.container}</code></p>` : ''}
          </div>
        `;
      } else {
        resultContent.innerHTML = `
          <div class="result-banner error">
            <h2>‚ùå Generation Failed</h2>
            <p style="margin-top: 1rem;">${data.message || 'An error occurred during generation.'}</p>
            ${data.workspace ? `<p style="margin-top: 1rem; color: #888;">üìÇ Partial workspace: <code>${data.workspace}</code></p>` : ''}
          </div>
        `;
      }
    }
    
    // Add files to the generated files list
    function addFilesToList(files) {
      const fileListSection = document.getElementById('file-list-section');
      const fileListEl = document.getElementById('generated-files');
      
      for (const file of files) {
        if (allGeneratedFiles.has(file)) continue;
        allGeneratedFiles.add(file);
        
        const ext = file.split('.').pop().toLowerCase();
        let type = 'text';
        let icon = 'üìÑ';
        
        if (ext === 'py') { type = 'python'; icon = 'üêç'; }
        else if (ext === 'js' || ext === 'ts' || ext === 'jsx' || ext === 'tsx') { type = 'javascript'; icon = 'üìú'; }
        else if (ext === 'json') { type = 'json'; icon = 'üìã'; }
        else if (ext === 'md') { type = 'markdown'; icon = 'üìù'; }
        else if (ext === 'txt') { type = 'text'; icon = 'üìÉ'; }
        else if (ext === 'html' || ext === 'css') { type = 'web'; icon = 'üåê'; }
        
        const fileItem = document.createElement('div');
        fileItem.className = `file-item ${type}`;
        fileItem.innerHTML = `<span class="icon">${icon}</span><span>${file}</span>`;
        fileListEl.appendChild(fileItem);
      }
      
      if (allGeneratedFiles.size > 0) {
        fileListSection.classList.remove('hidden');
      }
    }
    
    // Append to log
    function appendLog(text) {
      logOutput.textContent += text;
      logOutput.scrollTop = logOutput.scrollHeight;
    }
    
    // Append to console trace with timestamp and level
    let traceLineCount = 0;
    const MAX_TRACE_LINES = 200;
    
    function appendConsoleTrace(text, level = 'info') {
      if (!consoleTrace) return;
      
      // Pulse the indicator to show activity
      if (consoleIndicator) {
        consoleIndicator.style.animation = 'none';
        consoleIndicator.offsetHeight; // Force reflow
        consoleIndicator.style.animation = 'pulse-green 0.3s ease-out';
      }
      
      // Format timestamp
      const now = new Date();
      const timestamp = now.toTimeString().split(' ')[0] + '.' + String(now.getMilliseconds()).padStart(3, '0');
      
      // Clean up text - remove excessive newlines
      const cleanText = text.replace(/^\n+|\n+$/g, '').replace(/\n{3,}/g, '\n\n');
      if (!cleanText.trim()) return;
      
      // Create trace line
      const line = document.createElement('span');
      line.className = `trace-line ${level}`;
      line.textContent = `[${timestamp}] ${cleanText}\n`;
      
      consoleTrace.appendChild(line);
      traceLineCount++;
      
      // Keep trace buffer manageable
      while (traceLineCount > MAX_TRACE_LINES && consoleTrace.firstChild) {
        consoleTrace.removeChild(consoleTrace.firstChild);
        traceLineCount--;
      }
      
      // Auto-scroll to bottom
      consoleTrace.scrollTop = consoleTrace.scrollHeight;
    }
    
    // Clear console trace when starting new job
    function clearConsoleTrace() {
      if (consoleTrace) {
        consoleTrace.innerHTML = '';
        traceLineCount = 0;
      }
    }
    
    // Show deployment link in the UI
    let deploymentLinks = { docker: null, azure: null };
    
    function showDeploymentLink(type, url, resource) {
      deploymentLinks[type] = { url, resource };
      
      // Find or create the deployment links container
      let linksContainer = document.getElementById('deployment-links');
      if (!linksContainer) {
        linksContainer = document.createElement('div');
        linksContainer.id = 'deployment-links';
        linksContainer.style.cssText = `
          margin-top: 1rem;
          padding: 1rem;
          background: rgba(76, 175, 80, 0.1);
          border-radius: 8px;
          border: 1px solid #4CAF50;
        `;
        linksContainer.innerHTML = '<h3 style="color: #4CAF50; margin-bottom: 0.75rem;">üöÄ Deployed Applications</h3><div id="links-list"></div>';
        
        // Insert before the log output
        const logSection = document.querySelector('#section-generate .generation-pane:last-child');
        if (logSection) {
          logSection.insertBefore(linksContainer, logOutput.parentElement);
        }
      }
      
      const linksList = document.getElementById('links-list');
      const existingLink = document.getElementById(`link-${type}`);
      
      const linkHtml = type === 'docker' 
        ? `<div id="link-docker" style="margin-bottom: 0.5rem;">
            üê≥ <strong>Docker:</strong> 
            ${url ? `<a href="${url}" target="_blank" style="color: #64B5F6;">${url}</a>` : '(deploying...)'}
            <span style="color: #888; margin-left: 0.5rem;">[${resource}]</span>
          </div>`
        : `<div id="link-azure" style="margin-bottom: 0.5rem;">
            ‚òÅÔ∏è <strong>Azure:</strong> 
            ${url ? `<a href="${url}" target="_blank" style="color: #64B5F6;">${url}</a>` : '(see resource group)'}
            <span style="color: #888; margin-left: 0.5rem;">[${resource}]</span>
          </div>`;
      
      if (existingLink) {
        existingLink.outerHTML = linkHtml;
      } else {
        linksList.innerHTML += linkHtml;
      }
    }
  </script>
</body>
</html>
